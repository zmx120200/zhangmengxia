<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>统计报表</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .sidebar {
            min-height: 100vh;
            background-color: #2c3e50;
            color: white;
        }
        .sidebar a {
            color: white;
            text-decoration: none;
            display: block;
            padding: 10px;
        }
        .sidebar a:hover {
            background-color: #34495e;
        }
        .content {
            padding: 20px;
        }
        .stat-card {
            border-radius: 10px;
            padding: 20px;
            color: white;
            margin-bottom: 20px;
        }
        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 20px;
        }
        .report-section {
            margin-bottom: 30px;
        }
        .report-section h4 {
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .table th {
            background-color: #f8f9fa;
        }
    </style>
</head>
<body>
<div class="container-fluid">
    <div class="row">
        <!-- 侧边栏 -->
        <div class="col-md-2 sidebar">
            <h3 class="text-center py-3">管理员中心</h3>
            <div class="nav flex-column">
                <a href="/admin/dashboard">仪表板</a>
                <a href="/book/manage">图书管理</a>
                <a href="/admin/users/page">用户管理</a>
                <a href="/borrow/manage">借阅管理</a>
                <a href="/admin/reports/page" class="active">统计报表</a>
                <hr>
                <a href="/user/logout">退出登录</a>
            </div>
        </div>
        
        <!-- 主内容区 -->
        <div class="col-md-10 content">
            <h2>统计报表</h2>
            <p class="text-muted">系统数据统计和分析报告</p>
            
            <!-- 统计概览 -->
            <div class="row mt-4">
                <div class="col-md-3">
                    <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <h3 id="totalBorrows">0</h3>
                        <p>总借阅量</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        <h3 id="avgBorrowsPerDay">0.0</h3>
                        <p>日均借阅</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                        <h3 id="activeUsers">0</h3>
                        <p>活跃用户</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                        <h3 id="returnRate">0%</h3>
                        <p>归还率</p>
                    </div>
                </div>
            </div>
            
            <!-- 月度借阅统计 -->
            <div class="report-section">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h4>月度借阅统计</h4>
                        <div>
                            <select class="form-select form-select-sm" id="yearSelect" style="width: auto; display: inline-block;">
                                <option value="2025">2025年</option>
                                <option value="2024">2024年</option>
                                <option value="2023">2023年</option>
                            </select>
                            <button class="btn btn-sm btn-primary ms-2" id="refreshChart">刷新</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="monthlyBorrowChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 热门图书排行 -->
            <div class="report-section">
                <div class="card">
                    <div class="card-header">
                        <h4>热门图书排行</h4>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>排名</th>
                                        <th>图书名称</th>
                                        <th>作者</th>
                                        <th>借阅次数</th>
                                        <th>分类</th>
                                        <th>库存状态</th>
                                    </tr>
                                </thead>
                                <tbody id="popularBooksTable">
                                    <!-- 热门图书数据将通过JavaScript动态加载 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 活跃读者排行 -->
            <div class="report-section">
                <div class="card">
                    <div class="card-header">
                        <h4>活跃读者排行</h4>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>排名</th>
                                        <th>读者姓名</th>
                                        <th>用户名</th>
                                        <th>借阅次数</th>
                                        <th>当前借阅</th>
                                        <th>注册时间</th>
                                    </tr>
                                </thead>
                                <tbody id="activeReadersTable">
                                    <!-- 活跃读者数据将通过JavaScript动态加载 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 借阅分类分布 -->
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5>借阅分类分布</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="categoryDistributionChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5>借阅时段分布</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="timeDistributionChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 报表导出 -->
            <div class="card mt-4">
                <div class="card-header">
                    <h5>报表导出</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <button class="btn btn-primary w-100" onclick="exportReport('monthly')">
                                <i class="bi bi-file-earmark-text"></i> 月度报表
                            </button>
                        </div>
                        <div class="col-md-3 mb-3">
                            <button class="btn btn-success w-100" onclick="exportReport('quarterly')">
                                <i class="bi bi-file-earmark-spreadsheet"></i> 季度报表
                            </button>
                        </div>
                        <div class="col-md-3 mb-3">
                            <button class="btn btn-info w-100" onclick="exportReport('yearly')">
                                <i class="bi bi-file-earmark-pdf"></i> 年度报表
                            </button>
                        </div>
                        <div class="col-md-3 mb-3">
                            <button class="btn btn-warning w-100" onclick="exportReport('custom')">
                                <i class="bi bi-gear"></i> 自定义报表
                            </button>
                        </div>
                    </div>
                    <div class="mt-3">
                        <small class="text-muted">报表将导出为Excel/PDF格式，包含所有统计数据和图表</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script>
    $(document).ready(function() {
        // 加载报表数据
        loadReportData();
        
        // 刷新图表按钮点击事件
        $('#refreshChart').click(function() {
            loadReportData();
        });
    });
    
    function loadReportData() {
        // 显示加载状态
        showLoading();
        
        // 获取报表数据
        $.ajax({
            url: '/admin/reports',
            type: 'GET',
            success: function(response) {
                if (response.success) {
                    // 更新统计概览
                    $('#totalBorrows').text(response.totalBorrows || 0);
                    $('#avgBorrowsPerDay').text(response.avgBorrowsPerDay || '0.0');
                    $('#activeUsers').text(response.activeUsers || 0);
                    $('#returnRate').text(response.returnRate || '0%');
                    
                    // 创建月度借阅图表
                    if (response.monthlyStats) {
                        createMonthlyBorrowChart(
                            response.monthlyStats.labels,
                            response.monthlyStats.data
                        );
                    }
                    
                    // 更新热门图书表格
                    if (response.popularBooks) {
                        updatePopularBooksTable(response.popularBooks);
                    }
                    
                    // 更新活跃读者表格
                    if (response.activeReaders) {
                        updateActiveReadersTable(response.activeReaders);
                    }
                    
                    // 创建分类分布图表
                    createCategoryDistributionChart();
                    
                    // 创建时段分布图表
                    createTimeDistributionChart();
                    
                } else {
                    alert('加载报表数据失败：' + (response.message || '请重试！'));
                }
            },
            error: function() {
                alert('请求失败，请检查网络连接！');
            },
            complete: function() {
                hideLoading();
            }
        });
    }
    
    function showLoading() {
        // 显示加载状态
        $('#popularBooksTable').html('<tr><td colspan="6" class="text-center"><div class="spinner-border spinner-border-sm" role="status"></div> 加载中...</td></tr>');
        $('#activeReadersTable').html('<tr><td colspan="6" class="text-center"><div class="spinner-border spinner-border-sm" role="status"></div> 加载中...</td></tr>');
    }
    
    function hideLoading() {
        // 隐藏加载状态
    }
    
    function createMonthlyBorrowChart(labels, data) {
        const ctx = document.getElementById('monthlyBorrowChart').getContext('2d');
        
        // 如果已有图表实例，先销毁
        if (window.monthlyBorrowChart) {
            window.monthlyBorrowChart.destroy();
        }
        
        window.monthlyBorrowChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels || ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'],
                datasets: [{
                    label: '借阅数量',
                    data: data || [65, 59, 80, 81, 56, 55, 40, 72, 85, 90, 75, 60],
                    backgroundColor: 'rgba(54, 162, 235, 0.7)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `借阅数量: ${context.raw}`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: '借阅数量'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: '月份'
                        }
                    }
                }
            }
        });
    }
    
    function updatePopularBooksTable(books) {
        const tbody = $('#popularBooksTable');
        tbody.empty();
        
        if (books && books.length > 0) {
            books.forEach(function(book, index) {
                // 确定库存状态
                let stockStatus = '充足';
                let statusClass = 'text-success';
                
                if (book.stock === 0) {
                    stockStatus = '无库存';
                    statusClass = 'text-danger';
                } else if (book.stock <= 5) {
                    stockStatus = '紧张';
                    statusClass = 'text-warning';
                }
                
                const row = `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${book.name || '未知图书'}</td>
                        <td>${book.author || '未知作者'}</td>
                        <td><strong>${book.borrowCount || 0}</strong></td>
                        <td>${book.category || '未分类'}</td>
                        <td class="${statusClass}">${stockStatus}</td>
                    </tr>
                `;
                tbody.append(row);
            });
        } else {
            tbody.html('<tr><td colspan="6" class="text-center text-muted">暂无数据</td></tr>');
        }
    }
    
    function updateActiveReadersTable(readers) {
        const tbody = $('#activeReadersTable');
        tbody.empty();
        
        if (readers && readers.length > 0) {
            readers.forEach(function(reader, index) {
                // 格式化注册时间
                let registerTime = '-';
                if (reader.registerTime) {
                    const date = new Date(reader.registerTime);
                    registerTime = date.toLocaleDateString();
                }
                
                const row = `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${reader.name || '未知读者'}</td>
                        <td>${reader.username || 'N/A'}</td>
                        <td><strong>${reader.borrowCount || 0}</strong></td>
                        <td>${reader.currentBorrows || 0}</td>
                        <td>${registerTime}</td>
                    </tr>
                `;
                tbody.append(row);
            });
        } else {
            tbody.html('<tr><td colspan="6" class="text-center text-muted">暂无数据</td></tr>');
        }
    }
    
    function createCategoryDistributionChart() {
        const ctx = document.getElementById('categoryDistributionChart').getContext('2d');
        
        // 如果已有图表实例，先销毁
        if (window.categoryDistributionChart) {
            window.categoryDistributionChart.destroy();
        }
        
        // 模拟分类数据
        const categories = ['文学', '科技', '历史', '哲学', '艺术', '教育', '小说', '传记'];
        const data = categories.map(() => Math.floor(Math.random() * 50) + 20);
        
        // 生成颜色
        const backgroundColors = [
            'rgba(255, 99, 132, 0.7)',
            'rgba(54, 162, 235, 0.7)',
            'rgba(255, 206, 86, 0.7)',
            'rgba(75, 192, 192, 0.7)',
            'rgba(153, 102, 255, 0.7)',
            'rgba(255, 159, 64, 0.7)',
            'rgba(199, 199, 199, 0.7)',
            'rgba(83, 102, 255, 0.7)'
        ];
        
        window.categoryDistributionChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: categories,
                datasets: [{
                    data: data,
                    backgroundColor: backgroundColors,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.raw || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = Math.round((value / total) * 100);
                                return `${label}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }
    
    function createTimeDistributionChart() {
        const ctx = document.getElementById('timeDistributionChart').getContext('2d');
        
        // 如果已有图表实例，先销毁
        if (window.timeDistributionChart) {
            window.timeDistributionChart.destroy();
        }
        
        // 模拟时段数据
        const timeLabels = ['8-10点', '10-12点', '12-14点', '14-16点', '16-18点', '18-20点'];
        const data = timeLabels.map(() => Math.floor(Math.random() * 30) + 10);
        
        window.timeDistributionChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: timeLabels,
                datasets: [{
                    label: '借阅数量',
                    data: data,
                    borderColor: 'rgba(255, 99, 132, 1)',
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `借阅数量: ${context.raw}`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: '借阅数量'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: '时间段'
                        }
                    }
                }
            }
        });
    }
    
    function exportReport(type) {
        let message = '';
        switch(type) {
            case 'monthly':
                message = '月度报表导出功能开发中';
                break;
            case 'quarterly':
                message = '季度报表导出功能开发中';
                break;
            case 'yearly':
                message = '年度报表导出功能开发中';
                break;
            case 'custom':
                message = '自定义报表导出功能开发中';
                break;
            default:
                message = '报表导出功能开发中';
        }
        alert(message);
    }
</script>
</body>
</html>
